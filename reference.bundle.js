!function(n,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.reference=e():n.reference=e()}(this,function(){return function(n){function e(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return n[r].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var t={};return e.m=n,e.c=t,e.i=function(n){return n},e.d=function(n,t,r){e.o(n,t)||Object.defineProperty(n,t,{configurable:!1,enumerable:!0,get:r})},e.n=function(n){var t=n&&n.__esModule?function(){return n.default}:function(){return n};return e.d(t,"a",t),t},e.o=function(n,e){return Object.prototype.hasOwnProperty.call(n,e)},e.p="",e(e.s=5)}([function(n,e,t){(function(){var n,e,r={}.hasOwnProperty,i=[].indexOf||function(n){for(var e=0,t=this.length;e<t;e++)if(e in this&&this[e]===n)return e;return-1};n=t(1),e=t(2),this.main=function(t){return function(u,o,l,d){var a,f,c,s,m,p,_,h,v,b,y,g,x,w,j,O,F,N,k,P,E,q,z,A,M,S,Y,$,C,D,J,B,G,H,I;return g=function(n){throw{forbidden:n}},B=function(n){throw{unauthorized:n}},w=function(n){return n in u},x=function(n){return n in o},S=function(n){if(!w(n))return g("Field `"+n+"` is required.")},G=function(e){if(!n(o[e],u[e]))return g("Field `"+e+"` was modified.")},H=function(n){var e,t,i,o;t=[];for(e in n)r.call(n,e)&&(i=n[e],o=u[e],i(o,u)?t.push(void 0):t.push(g("Field `"+e+"` has invalid value `"+JSON.stringify(o)+"`.")));return t},Y=function(n){var e,t;null==n&&(n=[]),t=[];for(e in u)r.call(u,e)&&i.call(n,e)<0&&(x(e)?t.push(void 0):t.push(g("Field `"+e+"` was added.")));return t},C=function(n){var e,t;null==n&&(n=[]),t=[];for(e in o)r.call(o,e)&&i.call(n,e)<0&&(w(e)?t.push(void 0):t.push(g("Field `"+e+"` was removed.")));return t},$=function(n){var e,t;null==n&&(n=[]),t=[];for(e in u)r.call(u,e)&&"_revisions"!==e&&i.call(n,e)<0&&t.push(G(e));return t},O="_"===(null!=(A=u._id)?A[0]:void 0),a=null!=(M=u._id)?M.match(/^(\w+):(.+)$/):void 0,J=null!=a?a[1]:void 0,k=null!=a?a[2]:void 0,I=function(){switch(null!=J&&null!=k||g("`_id` must be <type>:<key>"),u.type!==J&&g("Missing or invalid `type` field."),u[J]!==k&&g("Field `"+J+"` must contain `"+k+"`."),J){case"number":return i.call(k,"@")>=0?"local-number":"global-number";default:return J}},s=l.db,z=l.name,D=l.roles,F=null!=z,m=function(){if(!F)return B("Not logged in.")},h=function(){if(S("updated_by"),u.updated_by!==z)return g("Field `updated_by` must contain `"+z+"`.")},P=function(n){return i.call(D,n)>=0},j=function(){return P("_admin")},f=d.admins,E=d.members,N=null!=(null!=E?E.names:void 0)&&i.call(E.names,z)>=0,_=function(){if(!N)return B("Not owner.")},v=e(o,u),y=function(){if(u._deleted)return g("You may not delete `"+J+"` documents.")},b=function(){if(null==o||o._deleted)return g("You may not create `"+J+"` documents.")},q=function(){var n,e;return null!=u._id&&(!!P(u._id)||!(!(e=u._id.match(/^(?:number|endpoint):\d+@(\S+)$/))||(n=e[1],!P("number_domain:"+n))))},p=function(){if(!q())return g("Not permitted to modify this record.")},c={doc:u,oldDoc:o,userCtx:l,secObj:d,id:u._id,rev:u._rev,forbidden:g,unauthorized:B,has:w,had:x,required:S,unchanged:G,validate_fields:H,restrict_adding_fields:Y,restrict_removing_fields:C,restrict_modifying_fields:$,is_design:O,type:J,key:k,validate_type:I,db:s,name:z,is_logged_in:F,enforce_logged_in:m,enforce_updated_by:h,roles:D,may:P,is:P,is_admin:j,admins:f,admins_names:null!=f?f.names:void 0,admins_roles:null!=f?f.roles:void 0,members:E,members_names:null!=E?E.names:void 0,members_roles:null!=E?E.roles:void 0,is_owner:N,enforce_ownership:_,event:v,forbid_deletion:y,forbid_creation:b,might:q,enforce_might:p},t.call(c,c)}}}).call(this)},function(n,e){(function(){n.exports=function(n,e){var t;return(t=function(n,e){var r,i,u,o,l,d,a,f;if(n===e)return!0;if(typeof n!=typeof e)return!1;if(null==n||"object"!=typeof n)return!1;if(null==e||"object"!=typeof e)return!1;if(n instanceof Array&&!(e instanceof Array))return!1;if(o=Object.keys(n),l=Object.keys(e),o.length!==l.length)return!1;for(o.sort(),l.sort(),r=i=0,d=o.length;i<d;r=++i)if((f=o[r])!==l[r])return!1;for(u=0,a=o.length;u<a;u++)if(f=o[u],!t(n[f],e[f]))return!1;return!0})(n,e)}}).call(this)},function(n,e){(function(){n.exports=function(n,e){var t,r;return r=[null,null,"create","tombstone",null,null,null,null,null,null,"modify","delete",null,null,"create",null],t=0,(null!=e?e._deleted:void 0)&&(t+=1),null!=e&&(t+=2),(null!=n?n._deleted:void 0)&&(t+=4),null!=n&&(t+=8),r[t]}}).call(this)},,,function(n,e,t){"use strict";var r,i=[].slice;r=t(0),n.exports.validate_user_doc=r.main(function(){if(!this.is_admin())return this.forbid_deletion()}),n.exports.tags=function(n){var e,t,r,u,o,l,d;if(null!=n.type&&null!=n.timestamp)return d=n.type,l=n.timestamp,o={},e=function(n){return o[n]=!0},null!=n.reference&&e("reference:"+n.reference),null!=n.number_domain&&e("number_domain:"+n.number_domain),null!=n.agent&&e("agent:"+n.agent),null!=n.tag&&e(n.tag),null!=(r=n.tags)&&r.forEach(e),null!=(u=n.in)&&u.forEach(e),t=function(n){var e;return n.match(/:/)?(e=n.split(":"),emit(i.call(e).concat([l]),{type:d})):emit(["tag",n,l],{type:d})},Object.getOwnPropertyNames(o).forEach(t)}}])});